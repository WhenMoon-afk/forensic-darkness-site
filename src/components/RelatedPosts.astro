---
import { getCollection } from 'astro:content';

interface Props {
  currentSlug: string;
  tags?: string[];
  limit?: number;
}

const { currentSlug, tags = [], limit = 3 } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;

// Get all posts except the current one
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const otherPosts = allPosts.filter(post => (post.data.slug || post.slug) !== currentSlug);

// Score posts by tag overlap
const scoredPosts = otherPosts.map(post => {
  const postTags = post.data.tags || [];
  const overlap = tags.filter(tag => postTags.includes(tag)).length;
  return { post, score: overlap };
});

// Sort by score (most related first), then by date
const relatedPosts = scoredPosts
  .filter(item => item.score > 0)
  .sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return new Date(b.post.data.date).getTime() - new Date(a.post.data.date).getTime();
  })
  .slice(0, limit)
  .map(item => item.post);
---

{relatedPosts.length > 0 && (
  <section class="mt-12 pt-8 border-t border-noir-border">
    <h3 class="text-xl font-display font-bold mb-6">Related Articles</h3>
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {relatedPosts.map(post => {
        const slug = post.data.slug || post.slug;
        const formattedDate = new Date(post.data.date).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        return (
          <a href={`${baseUrl}blog/${slug}`} class="group block p-4 bg-fd-card rounded-lg hover:bg-fd-card/80 transition-colors">
            <h4 class="font-medium text-fd-text group-hover:text-fd-primary transition-colors line-clamp-2 mb-2">
              {post.data.title}
            </h4>
            <time class="text-sm text-fd-muted">{formattedDate}</time>
          </a>
        );
      })}
    </div>
  </section>
)}
