---
import BaseLayout from './BaseLayout.astro';
import ContentWarning from '../components/ContentWarning.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ReadingProgress from '../components/ReadingProgress.astro';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description?: string;
  date: string;
  author?: string;
  tags?: string[];
  image?: string;
  wordCount?: number;
  slug: string;
  headings?: Heading[];
  prevPost?: { title: string; slug: string };
  nextPost?: { title: string; slug: string };
}

const { title, description, date, author, tags, image, wordCount, slug, headings = [], prevPost, nextPost } = Astro.props;

// Calculate reading time (average 200 words per minute)
const readingTime = wordCount ? Math.max(1, Math.ceil(wordCount / 200)) : null;

const formattedDate = new Date(date).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const isoDate = new Date(date).toISOString();

// Article structured data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description || title,
  "datePublished": isoDate,
  "dateModified": isoDate,
  "author": {
    "@type": "Person",
    "name": author || "Forensic Darkness"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forensic Darkness",
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/images/2023/05/forensic-darkness-logo.png", Astro.site)
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  }
};

if (image) {
  articleSchema.image = new URL(image, Astro.site).href;
}
---

<BaseLayout
  title={title}
  description={description}
  type="article"
  image={image}
  publishedTime={isoDate}
  modifiedTime={isoDate}
  author={author}
  tags={tags}
>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <ReadingProgress />

  <article class="py-12">
    <div class="container max-w-4xl">
      <!-- Breadcrumb -->
      <Breadcrumb items={[
        { label: 'Home', href: '/' },
        { label: 'Blog', href: '/blog' },
        { label: title }
      ]} />

      <!-- Header -->
      <header class="mb-10">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-display font-bold mb-4 leading-tight">
          {title}
        </h1>

        <div class="flex flex-wrap items-center gap-4 text-fd-muted">
          <time datetime={isoDate}>{formattedDate}</time>
          {author && (
            <>
              <span class="text-paper-dim">·</span>
              <span>By {author}</span>
            </>
          )}
          {readingTime && (
            <>
              <span class="text-paper-dim">·</span>
              <span>{readingTime} min read</span>
            </>
          )}
        </div>

        {tags && tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-4">
            {tags.map(tag => (
              <a
                href={`/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="px-2 py-1 text-xs bg-fd-card rounded-full text-fd-muted hover:text-fd-primary transition-colors"
              >
                {tag}
              </a>
            ))}
          </div>
        )}
      </header>

      <!-- Content Warning -->
      <ContentWarning type="disturbing" />

      <!-- Table of Contents -->
      <TableOfContents headings={headings} />

      <!-- Article Content -->
      <div class="prose-dark">
        <slot />
      </div>

      <!-- Footer -->
      <footer class="mt-12 pt-8 border-t border-noir-border">
        <div class="flex items-center justify-between">
          <a href="/blog" class="text-fd-primary hover:text-fd-accent flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to Blog
          </a>

          <!-- Share buttons -->
          <div class="flex items-center gap-3">
            <span class="text-fd-muted text-sm">Share:</span>
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-fd-muted hover:text-fd-primary"
              aria-label="Share on Twitter"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-fd-muted hover:text-fd-primary"
              aria-label="Share on Facebook"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <!-- Copy Link Button -->
            <button
              id="copy-link-btn"
              class="text-fd-muted hover:text-fd-primary transition-colors relative group"
              aria-label="Copy link to clipboard"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              <span id="copy-tooltip" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-noir-elevated text-xs text-paper-aged rounded opacity-0 pointer-events-none whitespace-nowrap transition-opacity">
                Copy link
              </span>
            </button>
          </div>
        </div>

        {/* Previous/Next Post Navigation */}
        {(prevPost || nextPost) && (
          <nav class="grid grid-cols-2 gap-4 mt-8 pt-8 border-t border-noir-border" aria-label="Article navigation">
            <p class="col-span-2 text-xs text-fd-muted text-center mb-2">
              <kbd class="px-1.5 py-0.5 bg-fd-dark rounded text-xs">j</kbd> next ·
              <kbd class="px-1.5 py-0.5 bg-fd-dark rounded text-xs">k</kbd> previous
            </p>
            <div>
              {prevPost && (
                <a href={`/blog/${prevPost.slug}`} class="group block">
                  <span class="text-xs text-fd-muted uppercase tracking-wide">Previous</span>
                  <span class="block text-fd-primary group-hover:text-fd-accent transition-colors line-clamp-2">
                    {prevPost.title}
                  </span>
                </a>
              )}
            </div>
            <div class="text-right">
              {nextPost && (
                <a href={`/blog/${nextPost.slug}`} class="group block">
                  <span class="text-xs text-fd-muted uppercase tracking-wide">Next</span>
                  <span class="block text-fd-primary group-hover:text-fd-accent transition-colors line-clamp-2">
                    {nextPost.title}
                  </span>
                </a>
              )}
            </div>
          </nav>
        )}
      </footer>

      <!-- Related Posts -->
      <RelatedPosts currentSlug={slug} tags={tags} />
    </div>
  </article>

  <!-- Copy Link Script -->
  <script>
    const copyBtn = document.getElementById('copy-link-btn');
    const tooltip = document.getElementById('copy-tooltip');

    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        if (tooltip) {
          tooltip.textContent = 'Copied!';
          tooltip.style.opacity = '1';
          setTimeout(() => {
            tooltip.style.opacity = '0';
            setTimeout(() => {
              tooltip.textContent = 'Copy link';
            }, 200);
          }, 2000);
        }
      } catch {
        // Silently fail - clipboard API may not be available
      }
    });

    copyBtn?.addEventListener('mouseenter', () => {
      if (tooltip) tooltip.style.opacity = '1';
    });
    copyBtn?.addEventListener('mouseleave', () => {
      if (tooltip && tooltip.textContent !== 'Copied!') {
        tooltip.style.opacity = '0';
      }
    });
  </script>

  <!-- Keyboard Navigation -->
  {(prevPost || nextPost) && (
    <script is:inline define:vars={{ prevUrl: prevPost ? `/blog/${prevPost.slug}` : null, nextUrl: nextPost ? `/blog/${nextPost.slug}` : null }}>
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (e.key === 'j' && nextUrl) {
          window.location.href = nextUrl;
        } else if (e.key === 'k' && prevUrl) {
          window.location.href = prevUrl;
        }
      });
    </script>
  )}
</BaseLayout>
